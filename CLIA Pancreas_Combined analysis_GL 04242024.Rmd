---
title: "CLIA Pancreas_Combined analysis_GL 04242024"
output: html_notebook
---
library(swimplot)
library(coxphf)
library(grid)
library(gtable)
library(readr) 
library(mosaic)
library(dplyr) 
library(survival) 
library(survminer) 
library(ggplot2)
library(scales)
library(ggthemes)
library(tidyverse)
library(gtsummary)
library(flextable)
library(parameters)
library(car)
library(ComplexHeatmap)

#This analysis is based on CLIA Pancreas Cohort. We will run analysis based on ctDNA and/or CA 19-9 in pre-op, MRD and Surveillance window. MRD window is defined as 2-12 weeks post-surgery and the Surveillance window as 12 weeks post-op if no adjuvant chemotherapy was given and 4 weeks after the end of chemotherapy for patients that received adjuvant chemotherapy.

#ctDNA positivity by stage and window
```{r}
#Number of Pts at the MRD Window - percentage positivity by stage
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.MRD.Window))
circ_datadf <- as.data.frame(circ_data)

total_mrd <- sum(!is.na(circ_data$ctDNA.MRD.Window))
print(total_mrd)
circ_data$ctDNA.MRD.Window <- as.factor(circ_data$ctDNA.MRD.Window)
cont_table_mrd <- table(circ_data$Stage, circ_data$ctDNA.MRD.Window)
print(cont_table_mrd)

#Number of Pts at the Surveillance Window - percentage positivity by stage
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.Surveillance.Window))
circ_datadf <- as.data.frame(circ_data)

total_surv <- sum(!is.na(circ_data$ctDNA.Surveillance.Window))
print(total_surv)
circ_data$ctDNA.Surveillance.Window <- as.factor(circ_data$ctDNA.Surveillance.Window)
cont_table_surv <- table(circ_data$Stage, circ_data$ctDNA.Surveillance.Window)
print(cont_table_surv)

#Number of Pts with ctDNA anytime post-op - percentage positivity by stage
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.postSx.anytime))
circ_datadf <- as.data.frame(circ_data)

total_anytime <- sum(!is.na(circ_data$ctDNA.postSx.anytime))
print(total_anytime)
circ_data$ctDNA.postSx.anytime <- as.factor(circ_data$ctDNA.postSx.anytime)
cont_table_anytime <- table(circ_data$Stage, circ_data$ctDNA.postSx.anytime)
print(cont_table_anytime)
```

#Radiological Recurrence rates by stage and window
```{r}
#Number of Pts at the MRD Window - percentage of radiological recurrence by stage
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.MRD.Window))
circ_datadf <- as.data.frame(circ_data)

total_mrd <- sum(!is.na(circ_data$Radiological.Recurrence))
print(total_mrd)
circ_data$Radiological.Recurrence <- as.factor(circ_data$Radiological.Recurrence)
cont_table_mrd <- table(circ_data$Stage, circ_data$Radiological.Recurrence)
print(cont_table_mrd)

#Number of Pts at the Surveillance Window - percentage of radiological recurrence by stage
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.Surveillance.Window))
circ_datadf <- as.data.frame(circ_data)

total_surv <- sum(!is.na(circ_data$Radiological.Recurrence))
print(total_surv)
circ_data$Radiological.Recurrence <- as.factor(circ_data$Radiological.Recurrence)
cont_table_surv <- table(circ_data$Stage, circ_data$Radiological.Recurrence)
print(cont_table_surv)

#We run Fisher's exact test for recurrence rates in Stage II vs III in the surveillance window
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="I",]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.Surveillance.Window))
circ_datadf <- as.data.frame(circ_data)

circ_data$Stage <- factor(circ_data$Stage, levels = c("II", "III"), labels = c("II", "III"))
circ_data$Radiological.Recurrence <- factor(circ_data$Radiological.Recurrence, levels = c("FALSE", "TRUE"), labels = c("No Recurrence", "Recurrence"))
contingency_table <- table(circ_data$Stage, circ_data$Radiological.Recurrence)
chi_square_test <- chisq.test(contingency_table)
print(chi_square_test)
fisher_exact_test <- fisher.test(contingency_table)
print(fisher_exact_test)
print(contingency_table)

#Number of Pts with ctDNA anytime post-op - percentage of radiological recurrence by stage
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.postSx.anytime))
circ_datadf <- as.data.frame(circ_data)

total_anytime <- sum(!is.na(circ_data$Radiological.Recurrence))
print(total_anytime)
circ_data$Radiological.Recurrence <- as.factor(circ_data$Radiological.Recurrence)
cont_table_anytime <- table(circ_data$Stage, circ_data$Radiological.Recurrence)
print(cont_table_anytime)
```

#Demographics Table
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_datadf <- as.data.frame(circ_data)

circ_data_subset <- circ_data %>%
  select(
    Gender,
    Resectability.Group,
    Surgery,
    NAC,
    Stage,
    Grade,
    MSI,
    KRAS.Detailed,
    BRCA2.Detailed,
    Radiological.Recurrence,
    RecSite,
    DFS_months) %>%
  mutate(
    Gender = factor(Gender, levels = c("FEMALE", "MALE"), labels = c("Female", "Male")),
    Resectability.Group = factor(Resectability.Group, levels = c(1, 2), labels = c("Resectable", "Unresectable")),
    Surgery = factor(Surgery, levels = c(1, 0), labels = c("Yes", "No")),
    NAC = factor(NAC, levels = c("TRUE", "FALSE"), labels = c("Yes", "No")),
    Stage = factor(Stage, levels = c("I", "II", "III", "IV"), labels = c("I", "II", "III", "IV")),
    Grade = factor(Grade, levels = c(1, 2, 3), labels = c("G1", "G2", "G3")),
    MSI = factor(MSI),
    KRAS.Detailed = factor(KRAS.Detailed),
    BRCA2.Detailed = factor(BRCA2.Detailed),
    Radiological.Recurrence = factor(Radiological.Recurrence, levels = c("FALSE", "TRUE"), labels = c("No Recurrence", "Recurrence")),
    RecSite = factor(RecSite),
    DFS_months = as.numeric(DFS_months))
table1 <- circ_data_subset %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{median} ({min} - {max})",
      all_categorical() ~ "{n} ({p}%)"),
    label = list(
      Gender ~ "Gender",
      Resectability.Group ~ "Resectability",
      Surgery ~ "Surgery Performed",
      NAC ~ "Neoadjuvant Treatment",
      Stage ~ "Overall Stage",
      Grade ~ "Histological Grade",
      MSI ~ "MSI Status",
      KRAS.Detailed ~ "KRAS Status",
      BRCA2.Detailed ~ "BRCA2 Status",
      Radiological.Recurrence ~ "Radiological Recurrence",
      RecSite ~ "Recurrence Site",
      DFS_months ~ "Disease-Free Survival (months)"),) %>%
  bold_labels()
table1
fit1 <- as_flex_table(
  table1,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE)
fit1
save_as_docx(fit1, path= "~/Downloads/table1.docx")
```



#Heatmap with Clinical & Genomics Factors
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data %>% arrange(Stage)
circ_datadf <- as.data.frame(circ_data)

ha <- HeatmapAnnotation(
  Stage = circ_data$Stage,
  Gender = circ_data$Gender,
  Surgery = circ_data$Surgery,
  NAC = circ_data$NAC,
  Grade = circ_data$Grade,
  MSI = circ_data$MSI,
  KRAS = circ_data$KRAS,
  BRCA2 = circ_data$BRCA2,
  ctDNA.MRD.Window = circ_data$ctDNA.MRD.Window,
  ctDNA.Surveillance.Window = circ_data$ctDNA.Surveillance.Window,
  ctDNA.anytime = circ_data$ctDNA.anytime,
  Radiological.Recurrence = circ_data$Radiological.Recurrence,
  
  col = list(Stage = c("I" = "seagreen1", "II" = "orange", "III" = "purple", "IV" = "brown2"),
    Gender = c("FEMALE" = "goldenrod" , "MALE" = "blue4"),
    Surgery = c("0" = "#C1211A", "1" ="#008BCE"),
    NAC = c("FALSE" = "cornflowerblue", "TRUE" ="darkmagenta"),
    Grade = c("0" = "grey", "1" = "coral", "2" ="darkgreen", "3" = "yellow3"),
    MSI = c("MSS" = "grey", "MSI-Hi" ="black"),
    KRAS = c("0" = "grey", "1" ="black"),
    BRCA2 = c("0" = "grey", "1" ="black"),
    ctDNA.MRD.Window = c("1" = "red3", "0" ="blue"),
    ctDNA.Surveillance.Window = c("1" = "red3", "0" ="blue"),
    ctDNA.anytime = c("1" = "red3", "0" ="blue"),
    Radiological.Recurrence = c("TRUE" = "red3", "FALSE" ="blue")
)
)
ht <- Heatmap(matrix(nrow = 0, ncol = length(circ_data$Stage)),show_row_names = FALSE,cluster_rows = F,cluster_columns = FALSE, top_annotation = ha)
pdf("heatmap.pdf",width = 7, height = 7)
draw(ht, annotation_legend_side = "bottom")
dev.off()
```


#Distribution of ctDNA
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!=4,]
circ_data <- circ_data[circ_data$ctDNA.Surg.1<=24,]
circ_datadf <- as.data.frame(circ_data)

hist(circ_data$ctDNA.Surg.1,
     col='gray',
     main='Surgery to first testing ctDNA interval (<6 months)',
     xlab='Weeks from date of surgery to first ctDNA test',
     ylab='ctDNA Samples',
     ylim=c(0,35),
     breaks=seq(0,24,1), xaxp=c(0,24,24))

filtered_data <- circ_data %>%
  filter(ctDNA.Surg.1 <= 24) %>%
  tally()
print(filtered_data)

filtered_data <- circ_data %>%
  filter(ctDNA.Surg.1 <= 2) %>%
  tally()
print(filtered_data)

filtered_data <- circ_data %>%
  filter(ctDNA.Surg.1 >2, ctDNA.Surg.1 <=4) %>%
  tally()
print(filtered_data)

filtered_data <- circ_data %>%
  filter(ctDNA.Surg.1 >4, ctDNA.Surg.1 <=8) %>%
  tally()
print(filtered_data)

filtered_data <- circ_data %>%
  filter(ctDNA.Surg.1 >8, ctDNA.Surg.1 <=12) %>%
  tally()
print(filtered_data)

filtered_data <- circ_data %>%
  filter(ctDNA.Surg.1 >12) %>%
  tally()
print(filtered_data)
```


#DFS by ctDNA at the MRD window
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.MRD.Window))
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","red"), title="DFS - ctDNA MRD Window", ylab= "Disease Free Survival", xlab="Months from Surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(12, 24))
circ_data$ctDNA.MRD.Window <- factor(circ_data$ctDNA.MRD.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```


#DFS by ctDNA at the MRD window - Landmark 12 weeks
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.MRD.Window))
circ_data$DFS_months=circ_data$DFS_months-3
circ_data <- circ_data[circ_data$DFS_months>=0,]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","red"), title="DFS - ctDNA MRD Window", ylab= "Disease Free Survival", xlab="Time from Landmark Timepoint (Months)", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(12, 24))
circ_data$ctDNA.MRD.Window <- factor(circ_data$ctDNA.MRD.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```


#DFS by ctDNA and NAC combination - four groups
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60

circ_data$ctDNA.MRD.NAC <- NA #first we create the variable for the ctDNA & NAC combination, and we assign values
circ_data <- circ_data %>%
  mutate(ctDNA.MRD.NAC = case_when(
    NAC == 1 & ctDNA.MRD.Window == 0 ~ 1,
    NAC == 1 & ctDNA.MRD.Window == 1 ~ 2,
    NAC == 0 & ctDNA.MRD.Window == 0 ~ 3,
    NAC == 0 & ctDNA.MRD.Window == 1 ~ 4
  ))

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.NAC, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.NAC, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","green","purple", "red"), title="DFS - ctDNA MRD Window & NAC", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("NAC & ctDNA(-)", "NAC & ctDNA(+)","Surgery & ctDNA(-)", "Surgery & ctDNA(+)"), legend.title="")
summary(KM_curve, times= c(0, 24))
circ_data$ctDNA.MRD.NAC <- factor(circ_data$ctDNA.MRD.NAC, levels=c("1","2", "3", "4"), labels = c("NAC & ctDNA(-)", "NAC & ctDNA(+)","Surgery & ctDNA(-)", "Surgery & ctDNA(+)"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.NAC, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
```

#DFS by ctDNA at the MRD window - Stage analysis
```{r}
#Analysis at Stage I
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage=="I",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","red"), title="DFS - ctDNA MRD Window | Stage I", ylab= "Disease Free Survival", xlab="Months from Surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(0,24))
circ_data$ctDNA.MRD.Window <- factor(circ_data$ctDNA.MRD.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Analysis at Stage II
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage=="II",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","red"), title="DFS - ctDNA MRD Window | Stage II", ylab= "Disease Free Survival", xlab="Months from Surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(0,24))
circ_data$ctDNA.MRD.Window <- factor(circ_data$ctDNA.MRD.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Analysis at Stage III
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage=="III",]
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","red"), title="DFS - ctDNA MRD Window | Stage III", ylab= "Disease Free Survival", xlab="Months from Surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(0,24))
circ_data$ctDNA.MRD.Window <- factor(circ_data$ctDNA.MRD.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```

#DFS by ctDNA at the Surveillance window
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.Surveillance.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.Surveillance.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=12, palette=c("blue","red"), title="DFS - ctDNA Surveillance Window", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(12, 24))
circ_data$ctDNA.Surveillance.Window <- factor(circ_data$ctDNA.Surveillance.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.Surveillance.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```


#DFS by ctDNA at the Surveillance window - Stage analysis
```{r}
#Analysis at Stage I
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage=="I",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.Surveillance.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.Surveillance.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=12, palette=c("blue","red"), title="DFS - ctDNA Surveillance Window | Stage I", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(12, 24))
circ_data$ctDNA.Surveillance.Window <- factor(circ_data$ctDNA.Surveillance.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.Surveillance.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Analysis at Stage II
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage=="II",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.Surveillance.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.Surveillance.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=12, palette=c("blue","red"), title="DFS - ctDNA Surveillance Window | Stage II", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(12, 24))
circ_data$ctDNA.Surveillance.Window <- factor(circ_data$ctDNA.Surveillance.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.Surveillance.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)

#Analysis at Stage III
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage=="III",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.Surveillance.Window, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.Surveillance.Window, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=12, palette=c("blue","red"), title="DFS - ctDNA Surveillance Window | Stage III", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("ctDNA Negative", "ctDNA Positive"), legend.title="")
summary(KM_curve, times= c(12, 24))
circ_data$ctDNA.Surveillance.Window <- factor(circ_data$ctDNA.Surveillance.Window, levels=c("0","1"))
cox_fit <- coxph(surv_object ~ ctDNA.Surveillance.Window, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
cox_fit_summary <- summary(cox_fit)

# Extract values for HR, 95% CI, and p-value
HR <- cox_fit_summary$coefficients[2]
lower_CI <- cox_fit_summary$conf.int[3]
upper_CI <- cox_fit_summary$conf.int[4]
p_value <- cox_fit_summary$coefficients[5]
label_text <- paste0("HR = ", round(HR, 2), " (", round(lower_CI, 2), "-", round(upper_CI, 2), "); p = ", round(p_value, 3))
print(label_text)
```

#Multivariate regression for DFS at the Surveillance Window
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- subset(circ_data, !is.na(ctDNA.Surveillance.Window))
circ_datadf <- as.data.frame(circ_data)

circ_datadf$Gender <- factor(circ_datadf$Gender, levels = c("FEMALE", "MALE"), labels = c("Female", "Male"))
circ_datadf$AT <- factor(circ_datadf$AT, levels = c("0", "1"), labels = c("No", "Yes"))
circ_datadf$NAC <- factor(circ_datadf$NAC, levels = c("TRUE", "FALSE"), labels = c("Therapy", "Upfront Surgery"))
circ_datadf$KRAS <- factor(circ_datadf$KRAS, levels = c("0", "1"), labels = c("wt", "Mut"))
circ_datadf$Stage <- factor(circ_datadf$Stage, levels = c("I", "II", "III"), labels = c("I", "II", "III"))
circ_datadf$CA.Surveillance.Window <- factor(circ_datadf$CA.Surveillance.Window, levels = c("0", "1"), labels = c("CA19-9 < 37 U/mL", "CA19-9 ≥ 37 U/mL"))
circ_datadf$ctDNA.Surveillance.Window <- factor(circ_datadf$ctDNA.Surveillance.Window, levels=c("0","1"), labels = c("Negative", "Positive"))
surv_object<-Surv(time = circ_datadf$DFS_months, event = circ_datadf$DFS.Event) 
cox_fit <- coxph(surv_object ~ Gender + AT + NAC + KRAS + Stage + CA.Surveillance.Window + ctDNA.Surveillance.Window, data=circ_datadf) 
ggforest(cox_fit, data = circ_datadf, main = "Multivariate Regression Model for DFS", refLabel = "Reference Group")
test.ph <- cox.zph(cox_fit)
```


#ctDNA Dynamics from MRD window to anytime
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_data <- subset(circ_data, !is.na(ctDNA.Dynamics.anytime))
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.Dynamics.anytime, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.Dynamics.anytime, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","green","purple", "red"), title="DFS - ctDNA Dynamics MRD to anytime", ylab= "Disease Free Survival", xlab="Months from Surgery", legend.labs=c("Persistently negative", "Converted negative","Converted positive", "Persistently positive"), legend.title="")
summary(KM_curve, times= c(0, 24))
circ_data$ctDNA.Dynamics.anytime <- factor(circ_data$ctDNA.Dynamics.anytime, levels=c("1", "2", "3", "4"), labels = c("Persistently negative", "Converted negative", "Converted positive", "Persistently positive"))
cox_fit <- coxph(surv_object ~ ctDNA.Dynamics.anytime, data=circ_data) 
summary(cox_fit)
```

#ctDNA Dynamics from MRD window to anytime - Landmark 12 weeks
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data$DFS_months=circ_data$DFS_months-3
circ_data <- circ_data[circ_data$DFS_months>=0,]
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
circ_data <- subset(circ_data, !is.na(ctDNA.Dynamics.anytime))
circ_datadf <- as.data.frame(circ_data)

survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.Dynamics.anytime, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.Dynamics.anytime, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","green","purple", "red"), title="DFS - ctDNA Dynamics MRD to anytime", ylab= "Disease Free Survival", xlab="Time From Landmark analysis (Months)", legend.labs=c("Persistently negative", "Converted negative","Converted positive", "Persistently positive"), legend.title="")
summary(KM_curve, times= c(0, 24))
circ_data$ctDNA.Dynamics.anytime <- factor(circ_data$ctDNA.Dynamics.anytime, levels=c("1", "2", "3", "4"), labels = c("Persistently negative", "Converted negative", "Converted positive", "Persistently positive"))
cox_fit <- coxph(surv_object ~ ctDNA.Dynamics.anytime, data=circ_data) 
summary(cox_fit)
```

#DFS by ctDNA and ACT combination in NAC-treated pts - four groups
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- circ_data[circ_data$NAC=="TRUE",]

circ_data$ctDNA.MRD.ACT <- NA #first we create the variable for the ctDNA & NAC combination, and we assign values
circ_data <- circ_data %>%
  mutate(ctDNA.MRD.ACT = case_when(
    AT == 1 & ctDNA.MRD.Window == 0 ~ 1,
    AT == 1 & ctDNA.MRD.Window == 1 ~ 3,
    AT == 0 & ctDNA.MRD.Window == 0 ~ 2,
    AT == 0 & ctDNA.MRD.Window == 1 ~ 4
  ))

circ_data <- subset(circ_data, !is.na(ctDNA.MRD.ACT))
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.ACT, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.ACT, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=12, palette=c("blue","green","orange", "red"), title="DFS - Neoadjuvant Setting w/o Adjuvant Treatment", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("NAC/ctDNA(-)/ACT", "NAC/ctDNA(-)/No ACT", "NAC/ctDNA(+)/ACT", "NAC/ctDNA(+)/No ACT"), legend.title="")
summary(KM_curve, times= c(0, 24))
circ_data$ctDNA.MRD.ACT <- factor(circ_data$ctDNA.MRD.ACT, levels=c("2","1","3","4"), labels = c("NAC/ctDNA(-)/No ACT", "NAC/ctDNA(-)/ACT", "NAC/ctDNA(+)/ACT", "NAC/ctDNA(+)/No ACT"))
cox_fit <- coxph(surv_object ~ ctDNA.MRD.ACT, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
```



#DFS by ctDNA and ACT combination in upfront surgery pts - four groups
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]
circ_data <- circ_data[circ_data$NAC=="FALSE",]

circ_data$ctDNA.MRD.ACT <- NA #first we create the variable for the ctDNA & NAC combination, and we assign values
circ_data <- circ_data %>%
  mutate(ctDNA.MRD.ACT = case_when(
    AT == 1 & ctDNA.MRD.Window == 0 ~ 1,
    AT == 1 & ctDNA.MRD.Window == 1 ~ 3,
    AT == 0 & ctDNA.MRD.Window == 0 ~ 2,
    AT == 0 & ctDNA.MRD.Window == 1 ~ 4
  ))

circ_data <- subset(circ_data, !is.na(ctDNA.MRD.ACT))
circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~ctDNA.MRD.ACT, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ ctDNA.MRD.ACT, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue","green","orange", "red"), title="DFS - Neoadjuvant Setting w/o Adjuvant Treatment", ylab= "Disease Free Survival", xlab="Months from surgery", legend.labs=c("Surgery/ctDNA(-)/ACT", "Surgery/ctDNA(-)/No ACT", "Surgery/ctDNA(+)/ACT", "Surgery/ctDNA(+)/No ACT"), legend.title="")
summary(KM_curve, times= c(0, 24))
circ_data$ctDNA.MRD.ACT <- factor(circ_data$ctDNA.MRD.ACT, levels=c("2","1","3","4"), labels = c("Surgery/ctDNA(-)/No ACT", "Surgery/ctDNA(-)/ACT", "Surgery/ctDNA(+)/ACT", "Surgery/ctDNA(+)/No ACT"))
cox_fit <- coxphf(surv_object ~ ctDNA.MRD.ACT, data=circ_data) 
summary(cox_fit)
```


#DFS by KRAS mutations
```{r}
rm(list=ls())
setwd("~/Downloads")
circ_data <- read.csv("CLIA Pancreas_GL.csv")
circ_data <- circ_data[circ_data$Include.analysis==TRUE,]
circ_data <- circ_data[circ_data$Surgery==1,]
circ_data <- circ_data[circ_data$Stage!="IV",]

circ_data$KRAS.status <- NA #first we create the variable for the ctDNA & NAC combination, and we assign values
circ_data <- circ_data %>%
  mutate(KRAS.status = case_when(
    KRAS.Detailed == "" ~ "1",
    KRAS.Detailed == "p.G12D" ~ "2",
    KRAS.Detailed == "p.G12V" ~ "3",
    KRAS.Detailed == "p.G12R" ~ "4"
  ))

circ_data <- subset(circ_data, !is.na(KRAS.status))
tally <- table(circ_data$KRAS.status)
print(tally)

circ_data$DFS_months[circ_data$DFS_months > 60] <- 60
survfit(Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)~KRAS.status, data = circ_data)
surv_object <-Surv(time = circ_data$DFS_months, event = circ_data$DFS.Event)
KM_curve <- survfit(surv_object ~ KRAS.status, data = circ_data,conf.int=0.95,conf.type="log-log") 
ggsurvplot(KM_curve, data = circ_data, pval = FALSE, conf.int = FALSE, risk.table = TRUE, break.time.by=6, palette=c("blue", "green", "purple", "red"), title="DFS - KRAS mutations", ylab= "Disease Free Survival", xlab="Months from Surgery", legend.labs=c("wt","G12D", "G12V", "G12R"), legend.title="")
summary(KM_curve, times= c(0, 12, 24))
circ_data$KRAS.status <- factor(circ_data$KRAS.status, levels =c("1", "2", "3", "4"), labels =c("wt","G12D", "G12V", "G12R"))
cox_fit <- coxph(surv_object ~ KRAS.status, data=circ_data) 
ggforest(cox_fit,data = circ_data) 
summary(cox_fit)
```

